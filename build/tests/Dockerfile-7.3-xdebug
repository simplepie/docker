FROM simplepieng/base:7.3
ENV BUILD_DEPS alpine-sdk curl-dev icu-dev libxml2-dev libxslt-dev git autoconf
ENV XDEBUG_VERSION 2.7.2

# Install Packages
RUN apk add --virtual .build-deps $BUILD_DEPS
RUN cd /tmp && \
	git clone git://github.com/xdebug/xdebug.git && \
	cd /tmp/xdebug && \
    git checkout ${XDEBUG_VERSION} && \
    sh ./rebuild.sh

#-------------------------------------------------------------------------------

FROM simplepieng/base:7.3

RUN echo "zend_extension=xdebug.so" > /usr/local/etc/php/conf.d/xdebug.ini
RUN mkdir -p /usr/local/lib/php/extensions/no-debug-non-zts-20170718
RUN apk add make

# Copy PHP Config
COPY build/tests/php.ini /usr/local/etc/php/php.ini
COPY --from=0 /tmp/xdebug/modules/xdebug.so /usr/local/lib/php/extensions/no-debug-non-zts-20180731/xdebug.so

WORKDIR /workspace
ENTRYPOINT ["make", "test"]
